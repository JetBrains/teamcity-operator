name: Trigger TeamCity on /test

on:
  issue_comment:
    types: [created, edited]

jobs:
  trigger-teamcity:
    name: Trigger TeamCity pipeline
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      issues: write
      contents: write
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/test')
    outputs:
      build_id: ${{ steps.trigger.outputs.build_id }}
      build_url: ${{ steps.trigger.outputs.build_url }}
    steps:
      - name: Validate and get PR branch
        id: pr
        run: |
          TOKEN="${{ github.token }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.comment.user.login }}"
          PR_NUM="${{ github.event.issue.number }}"

          PERM=$(curl -s -H "Authorization: Bearer $TOKEN" "https://api.github.com/repos/$REPO/collaborators/$AUTHOR/permission" | jq -r '.permission // empty')
          [ "$PERM" = "admin" ] || { echo "::error::Only repository owners can trigger this. User '$AUTHOR' has permission: ${PERM:-none}."; exit 1; }

          BRANCH=$(curl -s -H "Authorization: Bearer $TOKEN" "https://api.github.com/repos/$REPO/pulls/$PR_NUM" | jq -r '.head.ref // empty')
          [ -n "$BRANCH" ] || { echo "::error::Could not get PR head branch"; exit 1; }

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Trigger TeamCity pipeline
        id: trigger
        env:
          TEAMCITY_SERVER_URL: ${{ vars.TEAMCITY_SERVER_URL }}
          TEAMCITY_PIPELINE_ID: ${{ vars.TEAMCITY_PIPELINE_ID }}
          TEAMCITY_TOKEN: ${{ secrets.TEAMCITY_TOKEN }}
          BRANCH_NAME: ${{ steps.pr.outputs.branch }}
        run: |
          [ -n "$TEAMCITY_SERVER_URL" ] && [ -n "$TEAMCITY_PIPELINE_ID" ] && [ -n "$TEAMCITY_TOKEN" ] || \
            { echo "::error::Set TEAMCITY_SERVER_URL, TEAMCITY_PIPELINE_ID (variables) and TEAMCITY_TOKEN (secret)."; exit 1; }

          BASE="${TEAMCITY_SERVER_URL%/}"
          BODY=$(jq -n --arg id "$TEAMCITY_PIPELINE_ID" --arg branch "$BRANCH_NAME" '{ buildType: { id: $id }, branchName: $branch }')
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$BASE/app/rest/buildQueue" \
            -H "Content-Type: application/json" -H "Accept: application/json" -H "Authorization: Bearer $TEAMCITY_TOKEN" -d "$BODY")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY_JSON=$(echo "$RESPONSE" | sed '$d')

          [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ] || { echo "::error::TeamCity trigger failed (HTTP $HTTP_CODE)"; echo "$BODY_JSON"; exit 1; }
          BUILD_ID=$(echo "$BODY_JSON" | jq -r '.id // empty')
          [ -n "$BUILD_ID" ] || { echo "::error::Could not parse build id"; echo "$BODY_JSON"; exit 1; }

          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "build_url=$BASE/viewLog.html?buildId=$BUILD_ID" >> $GITHUB_OUTPUT